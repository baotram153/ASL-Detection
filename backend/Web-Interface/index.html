<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />
    <title>Alphabet Sign Language Detection</title>

    <link rel="stylesheet" href="./global.css" />
    <link rel="stylesheet" href="./index.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,400;0,600;0,700;1,300&display=swap"
    />
  </head>
  <body>
    <div class="index">
      <div class="headertitlebar">
        <a>Alphabet Sign Language Detection</a>
      </div>

      <div class="bottombar"></div>
      <div class="log-character"></div>
      <i class="by-khiem-nguyen">
        By Khiem Nguyen (2211570), Van Trong (2213964), Tram Dang (2213568) and
        Vinh Le (2213964)
      </i>

      <div class="camframe" id="webcam-container">
        <video id="video" autoplay></video>
      </div>
      <script>
        navigator.mediaDevices.getUserMedia({video: true})
          .then(function(stream) {
            var video = document.getElementById('video');
            video.srcObject = stream;
            video.onloadedmetadata = function(e) {
              video.width = this.videoWidth;
              video.height = this.videoHeight;
              video.play();

              video.style.transform = 'scaleX(-1)';
            };
          })
          .catch(function(err) {
            console.error('Error accessing webcam: ', err);
          });
      </script>

      <div class="main-text-frame">
        <div id="main-text"></div>
      </div>

      <div class="top5probframe">
        <div id="label-container"></div>
      </div>
      

      <div class="logframe">
        <div id="log-character"></div>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
      <script type="text/javascript">
        const URL = "./tm-my-image-model/";

        let model, webcam, labelContainer, maxPredictions;
        let mostProbableCharacter = "";
        let lastCharacter = "";

        async function init() {
          const modelURL = URL + "model.json";
          const metadataURL = URL + "metadata.json";

          model = await tmImage.load(modelURL, metadataURL);
          maxPredictions = model.getTotalClasses();

          const flip = true;
          webcam = new tmImage.Webcam(600, 600, flip);
          await webcam.setup();
          await webcam.play();
          window.requestAnimationFrame(loop);

          labelContainer = document.getElementById("label-container");
          for (let i = 0; i < 5; i++) {
            labelContainer.appendChild(document.createElement("div"));
          }
        }

        async function loop() {
          webcam.update();
          await predict();
          window.requestAnimationFrame(loop);
        }

        async function predict() {
          // predict can take in an image, video or canvas html element
          const prediction = await model.predict(webcam.canvas);

          prediction.sort((a, b) => parseFloat(b.probability) - parseFloat(a.probability));

          
          for (let i = 0; i < 5; i++) {
              const classPrediction =
                  prediction[i].className + " - " + prediction[i].probability.toFixed(4);
              labelContainer.childNodes[i].innerHTML = classPrediction;
          }

          if (prediction[0].className !== lastCharacter && prediction[0].className !== "!") {
            lastCharacter = prediction[0].className;
            document.getElementById("main-text").innerHTML = prediction[0].className;
            mostProbableCharacter += prediction[0].className;
            document.getElementById("log-character").innerHTML = mostProbableCharacter;
          }

          await new Promise(resolve => setTimeout(resolve, 500));
        }

        init();
      </script>
    </div>
  </body>
</html>